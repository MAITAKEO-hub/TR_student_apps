const FONT = '30px monospace'//フォント
const FONTSTYLE = '#ffffff'//フォントの色
const WNDSTYLE = 'rgba(0,0,0,0.75)' //ウィンドウの色
const HEIGHT = 480 //仮想画面サイズ　高さ
const WIDTH = 640 //　仮想画面サイズ　幅
const INTERVAL = 33;//フレーム呼び出し間隔
const TILESIZE = 32; //タイルサイズ
const TILECOLUMN =16;//タイル桁数
const TILEROW = 12;//タイル行数
const MAP_HEIGHT = 64;//マップの高さ
const MAP_WIDTH = 90;//マップの幅
const SCR_HEIGHT = 12;//画面タイルサイズの半分の高さ
const SCR_WIDTH = 12;//画面タイルサイズの半分の幅
const SCROLL = 8;//スクロール速度
const CHRHEIGHT = 32;//キャラクターの高さ
const CHRWIDTH = 24;//キャラクターの幅
const START_X = 12;//勇者スタート位置_X
const START_Y = 12;//勇者スタート位置_Y
const START_HP = 30;//最初のHP

const gKey = new Uint8Array(0x100);//キー入力バッファ

let gAngle = 2;//プレイヤーの向き
let gEx = 0;//経験値
let gHP = START_HP;//プレイヤーのHP
let gMHP = START_HP;//プレイヤーの最大HP
let gLv = 1;//プレイヤーのレベル
let gScreen;//仮想画面
let gFrame = 0;//内部カウンタ
let gWidth;//実画面の幅
let gHeight; //実画面の高さ
let gMoveX = 0;//移動量X
let gMoveY = 0;//移動量Y
let gImgMap;//マップ
let gImgPlayer//勇者
let gImgMonster//モンスター
let gImgBoss;//BOSS
let gItem = 0;//所持アイテム
let gPhase = 0;//戦闘フェーズ
let gPlayerX = START_X * TILESIZE + TILESIZE / 2;//勇者座標X
let gPlayerY = START_Y * TILESIZE + TILESIZE / 2;//勇者座標Y
let gMessage1 = null;//表示メッセージ 1
let gMessage2 = null;//表示メッセージ 2
let gCursor = 0;//カーソル位置
let gEnemyType;//敵種別
let gEnemyHP;//敵HP
let gOrder;//行動順

const gFileMap    = 'WorldMap-A2.png';
const gFilePlayer = '勇者.png';
const gFileMonster = 'monster.png';
const gFileBoss = '魔王.png';

const gEncounter = [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                    2,2,2,2,2,2,2,2,2,0,1,1,0,0,0,0,
                    0,0,0,0,0,0,4,4];//敵とのエンカウント確率

const gMonsterName = ['スライム','バット','ブループラント','おおみみず','パロット','ゴースト','マドハンド','スカル','ゴブリン','あやしいツボ','グリーンナイト','竜王'];//モンスターの名前

//マップ90*64
const gMap = [
1,1,1,1,1,1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1,10, 6, 6, 6, 6, 6, 6, 6, 6, 6,11, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,10, 6, 6, 6, 6, 6,11, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 6, 6, 6, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1,10, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5,11, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,10, 7,70,70,70,70,70, 5, 6,11, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,10, 7, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1,10, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5,11, 1, 1, 1, 1, 1, 1, 1,10, 6, 7,22,23,23,23,23,21,70,70, 5,11, 1, 1, 1, 1, 1, 1, 1, 1, 1,10, 6, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1,10, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5,11, 1, 1, 1, 1,10, 6, 7,70,70,25,21,21,21,21,21,21,24,70, 5,11, 1, 1, 1, 1, 1, 1, 1,10, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 8, 0, 0, 0, 0, 0, 0,37,38,39, 0, 0, 0, 0, 0, 0, 5,11, 1,10, 6, 7, 0, 0,22,23,21,21,21,21,21,21,21,21,24,70, 5,11, 1, 1, 1, 1, 1,10, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 8, 0, 0, 0, 0, 0, 0,40,41,42, 0, 0, 0, 0, 0, 0, 0, 5, 6, 7, 0, 0, 0,22,21,21,21,21,21,21,21,21,21,21,21,24,70, 5,11, 1, 1, 1,10, 7, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 8, 0, 0, 0, 0, 0, 0,43,44,45, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,25,21,21,21,21,21,21,21,21,21,21,21,21,24,70, 9, 1, 1,10, 7, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1,12, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,27,28,28,28,28,28,28,28,28,28,28,21,21,26,70, 9, 1, 1, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1,12, 3, 4, 0, 0,46,47, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,31,70,70,70,70,61,62,63,70,70,25,21,21,26,70, 9, 1, 1, 8, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1,12, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,22,23,24,70,70,70,70,64,65,66,70,70,25,21,21,29,70, 9, 1, 1, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1,12, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,25,21,26,70,70,70,70,67,68,69,70,70,25,21,26,70,70, 9, 1, 1, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1, 1, 1,12, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,25,21,26,70,70,70,70,70,70,70,70,70,25,21,29,70, 2,13, 1, 1, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1, 1, 1, 1, 1, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,25,21,26,70,70,70,70,70,70,70,70,70,27,29,70,70, 9, 1, 1,10, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1,10, 6, 6,11,12, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,25,21,26,70,70,70,70,70,70,70,70,70,70,70,70, 2,13, 1, 1, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1, 8, 0, 0, 5, 6, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,25,21,26,70,70,70,70,70,70,70,70,70,70,70, 2,13, 1, 1, 1, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1,10, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,25,21,26,70,70,70,70,70,70,70,70,70,70, 2,13, 1, 1, 1,10, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1,10, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,25,21,26,70,70,70,70,70,70,70,70,70, 2,13, 1, 1, 1,10, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1,10, 7,71,71,71,71,71, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,25,21,26,70,70,70, 2, 4,70,70,70, 2,13, 1, 1, 1,10, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1,10, 7,71,71,71,71,71,71,71,71,71,71, 0, 0, 0, 0, 0, 0, 0, 0, 0,27,28,29,70, 2, 3,13,12, 3, 3, 3,13, 1, 1,10, 6, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 8,71,71,71,71,71,71,71,71,72,71,71,71, 0, 0, 0, 0, 0, 0, 0, 0,70,70, 2, 3,13, 1, 1, 1, 1, 1, 1, 1, 1, 1, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 8,71,71,71,71,71,71,71,71,71,71,71,71, 0, 0, 0, 0, 0, 0, 0, 0,70, 2,13, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,10, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 8,71,71,71,71,60,71,71,71,71,71,71,71,71, 0, 0, 0, 0, 0, 0, 0,70, 9, 1, 1, 1, 1, 1, 1, 1,10, 6, 6, 6, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1,12, 4,71,71,71,71,71,71,71,71,71,71,71,71, 0, 0, 0, 0, 0, 0, 0, 2,13, 1, 1, 1, 1,10, 6, 6, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1,12, 4,71,71,71,71,71,71,71,71,71,71,71, 0, 0, 0, 0, 0, 0, 0, 9, 1, 1, 1,10, 6, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1,12, 3, 4,71,71,71,71,71,71,71,71,71, 0, 0, 0, 0, 0, 2, 3,13, 1, 1,10, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1,12, 3, 3, 3, 3, 3, 4,71,71,71, 0, 0, 0, 0, 2,13, 1, 1, 1,10, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1, 1,10, 6, 6,11, 1,12, 3, 3, 3, 4, 0, 0, 2,13, 1, 1,10, 6, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1,10, 7, 0, 0, 5,11, 1, 1, 1, 1,12, 3, 3,13, 1, 1,10, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1,10, 7, 0, 0, 0, 0, 5, 6,11, 1, 1, 1, 1, 1, 1,10, 6, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 8, 0, 0, 0, 0, 0, 0, 0, 5, 6,11, 1, 1, 1, 1, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 6, 6, 6, 6, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1,10, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1,10, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1,10, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1,1,1,1,1,
1,1,1,1,1,1, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,1,1,1,1,
1,1,1,1,1,1, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,1,1,1,1,
1,1,1,1,1,1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0,61,62,63, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0,64,65,66, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0,67,68,69, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
1,1,1,1,1,1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,
]

//戦闘行動処理
function Action() {
  gPhase++;//フェーズ経過

  if (((gPhase + gOrder) & 1) == 0) {//敵の攻撃
    let d = GetDamage(gEnemyType + 2);
    SetMessage(gMonsterName[gEnemyType] + 'の攻撃', d + 'のダメージ');
    gHP -= d;//プレイヤーのHP減少
    if (gHP <= 0) {
      gPhase = 7;
    }
    return;
  }

  if (gCursor == 0) {//戦うを選択時、プレイヤーの攻撃
    const d = GetDamage(gLv + 1);
    SetMessage('あなたの攻撃', d + 'のダメージ');
    gEnemyHP -= d;
    if (gEnemyHP <= 0) {
      gPhase = 5;
    }
    return;
  }

  if (Math.random() < 0.5) {//にげれる確率 
    SetMessage('あなたは逃げ出した', null);
    gPhase = 6;
    return;
  }

  //逃げる失敗時
  SetMessage('あなたは逃げ出した', 'しかし回りこまれた');

}

//経験値加算
function AddExp(val) {
  gEx += val;//経験値加算
  while (gLv * (gLv + 1) * 2 <= gEx) {//レベルアップの条件を満たしている場合
    gLv++;   //レベルアップ
    gMHP += 4 + Math.floor(Math.random() * 3);//さいだいHP上昇4~6
  }
}

//敵出現処理
function AppearEnemy(t) {
  gPhase = 1;
  gEnemyHP = t * 3 + 5;//敵HP 
  gEnemyType = t;
  SetMessage(gMonsterName[gEnemyType] + 'が現れた', null);
}

//コマンド選択
function CommandFight() {
  gPhase = 2    //戦闘コマンド選択フェーズ
  gCursor = 0;
  SetMessage(' 戦う', ' 逃げる');
}

//戦闘画面処理
function DrawFight(g) {
  g.fillStyle = '#000000';//背景色
  g.fillRect(0, 0, WIDTH, HEIGHT);//画面全体に描画

  if (gPhase <= 5) {//敵が生存している場合
    if (IsBoss()) {//ラスボスの場合
      g.drawImage(gImgBoss, WIDTH / 2 - gImgBoss.width / 2, HEIGHT / 2 - gImgBoss.height / 2);
    } else {
      let w = gImgMonster.width / 11;
      let h = gImgMonster.height;
      g.drawImage(gImgMonster, gEnemyType * w, 0, w, h, Math.floor(WIDTH / 2 - w / 2), Math.floor(HEIGHT / 2 - h / 2), w, h);//
    }
  }

  DrawMessage(g);//メッセージ描画
  DrawStatus(g);//ステータス描画

  if (gPhase == 2) {    //戦闘フェーズがコマンド選択中の場合
    g.fillText('➡', 125, 425 + 40 * gCursor); //カーソル描画
  }


}

//フィールド描画処理
function DrawField(g) {
  let mx = Math.floor(gPlayerX / TILESIZE);//プレイヤーのタイル座標X
  let my = Math.floor(gPlayerY / TILESIZE);//プレイヤーのタイル座標Y

  for (let dy = -SCR_HEIGHT; dy <= SCR_HEIGHT; dy++) {
    let ty = my + dy;//タイル座標Y
    let py = (ty + MAP_HEIGHT) % MAP_HEIGHT;//ループ後タイル座標Y
    for (let dx = -SCR_WIDTH; dx <= SCR_WIDTH; dx++) {
      let tx = mx + dx;//タイル座標X
      let px = (tx + MAP_WIDTH) % MAP_WIDTH;//ループ後タイル座標X

      DrawTile(g,
        tx * TILESIZE + WIDTH / 2 - gPlayerX,
        ty * TILESIZE + HEIGHT / 2 - gPlayerY,
        gMap[py * MAP_WIDTH + px]);
    }
  }

  //プレイヤー
  g.drawImage(gImgPlayer,
    (gFrame >> 3 & 3) * CHRWIDTH, gAngle * CHRHEIGHT, CHRWIDTH, CHRHEIGHT,
    WIDTH / 2 - CHRWIDTH / 2, HEIGHT / 2 - CHRHEIGHT + TILESIZE / 2, CHRWIDTH, CHRHEIGHT)

  //ステータスウィンドウ
  g.fillStyle = WNDSTYLE;//ウィンドウの色
  g.fillRect(15, 15, 100, 100);

  DrawMessage(g);//メッセージ描画
  DrawStatus(g);//ステータス描画

}


function DrawMain() {
  const g = gScreen.getContext('2d');

  if (gPhase == 0) {
    DrawField(g);//フィールド画面描画
  } else {
    DrawFight(g);
  }

  /*  g.fillStyle = WNDSTYLE;//ウィンドウの色
    g.fillRect (120,3,400,30);

    g.font = FONT;
    g.fillStyle = FONTSTYLE;
    g.fillText('x=' + gPlayerX + '  y=' + gPlayerY + '  m=' + gMap[ my * MAP_WIDTH + mx ], 155,25);
*/
}

//メッセージ描画
function DrawMessage(g) {
  if (!gMessage1) {      //メッセージが存在しない場合 
    return;
  }

  g.fillStyle = WNDSTYLE;//ウィンドウの色
  g.fillRect(120, 390, 400, 80);

  g.font = FONT;
  g.fillStyle = FONTSTYLE;

  g.fillText(gMessage1, 155, 425);
  if (gMessage2) {
    g.fillText(gMessage2, 155, 465);
  }
}

//ステータス描画
function DrawStatus(g) {
  g.font = FONT;
  g.fillStyle = FONTSTYLE;
  g.fillText('Lv' + gLv, 25, 40);//Lv
  g.fillText('HP' + gHP, 25, 75);//HP
  g.fillText('Ex' + gEx, 25, 110);//Ex
}

function DrawTile(g, x, y, idx) {
  const ix = (idx % TILECOLUMN) * TILESIZE;
  const iy = Math.floor(idx / TILECOLUMN) * TILESIZE;
  g.drawImage(gImgMap, ix, iy, TILESIZE, TILESIZE, x, y, TILESIZE, TILESIZE);
}

//ダメージ量計算式
function GetDamage(a) {
  return (Math.floor(a * (1 + Math.random())))//攻撃力の1~2倍
}

function IsBoss() {
  return (gEnemyType == gMonsterName.length - 1);
}

function LoadImage() {
  gImgMap = new Image(); gImgMap.src = gFileMap   //マップ画像の読み込み
  gImgPlayer = new Image(); gImgPlayer.src = gFilePlayer//勇者の読み込み
  gImgMonster = new Image(); gImgMonster.src = gFileMonster//モンスター読み込み
  gImgBoss = new Image(); gImgBoss.src = gFileBoss//ボス読み込み
}

function SetMessage(v1, v2) {
  gMessage1 = v1;
  gMessage2 = v2;
}

//フィールド進行処理
function TickField() {
  if (gPhase != 0) {
    return;
  }

  if (gMoveX != 0 || gMoveY != 0 || gMessage1) { }//移動又メッセージ中の場合
  else if (gKey[37]) { gAngle = 3; gMoveX = -TILESIZE; }//左
  else if (gKey[38]) { gAngle = 0; gMoveY = -TILESIZE; }//上
  else if (gKey[39]) { gAngle = 1; gMoveX = TILESIZE; }//右
  else if (gKey[40]) { gAngle = 2; gMoveY = TILESIZE; }//下

  //移動後のタイル座標判定
  let mx = Math.floor((gPlayerX + gMoveX) / TILESIZE);//移動後のタイル座標X
  let my = Math.floor((gPlayerY + gMoveY) / TILESIZE);//移動後のタイル座標Y
  mx += MAP_WIDTH//マップループ処理X
  mx %= MAP_WIDTH//マップループ処理X
  my += MAP_HEIGHT//マップループ処理Y
  my %= MAP_HEIGHT//マップループ処理Y
  let m = gMap[my * MAP_WIDTH + mx]//タイル番号
  if (1 <= m && m <= 30) {  //侵入不可の地形の場合
    gMoveX = 0;
    gMoveY = 0;
  }

  //イベント
  if (Math.abs(gMoveX) + Math.abs(gMoveY) === SCROLL) {

    if (m === 37 || m === 38 || m === 39 || m === 40 || m === 41 || m === 42 || m === 43 || m === 44 || m === 45) {//城
      gHP = gMHP;//HP回復
      SetMessage('魔王を倒して', null);
    }

    if (m == 60) {//ピラミッド
      gItem = 1;//たいまつ入手
      SetMessage("たいまつを手に入れた", null);
    }

    if (m == 31) { // 洞窟
      if (gItem == 0) {//たいまつを保持していない場合
        gPlayerX -= TILESIZE;//１マス左へ移動
        SetMessage("たいまつが必要です", null);
      } else {
        SetMessage("どうくつを通り抜けた", null);
      }
    }

    if (m === 68) {//ボス
      AppearEnemy(gMonsterName.length - 1);
    }

    if (Math.random() * 8 < gEncounter[m]) { //ランダムエンカウント
      let t = Math.abs(gPlayerX / TILESIZE - START_X) +
        Math.abs(gPlayerY / TILESIZE - START_Y);
      if (m == 48 || m == 49 || m == 50 || m == 51 || m == 52 || m == 53 || m == 54 || m == 55 || m == 56) {//森の場合
        t += 12;//敵のレベルを3上昇
      }
      
      if (m == 71) {//砂漠の場合
        t += 20;//敵のレベルを5上昇
      }
      if (m == 70) {//岩肌の場合
        t += 28;//敵のレベルを７上昇
      }

      t += Math.random() * 2;//敵のレベルを0~0.5上昇
      t = Math.floor(t / 4);
      t = Math.min(t, gMonsterName.length - 2);
      AppearEnemy(t);

    }
  }


  gPlayerX += Math.sign(gMoveX) * SCROLL;//プレイヤー座標移動X
  gPlayerY += Math.sign(gMoveY) * SCROLL;//プレイヤー座標移動Y
  gMoveX -= Math.sign(gMoveX) * SCROLL;//移動量消費X
  gMoveY -= Math.sign(gMoveY) * SCROLL;//移動量消費Y

  //マップループ処理
  gPlayerX += (MAP_WIDTH * TILESIZE);
  gPlayerX %= (MAP_WIDTH * TILESIZE);
  gPlayerY += (MAP_HEIGHT * TILESIZE);
  gPlayerY %= (MAP_HEIGHT * TILESIZE);

}

function WmPaint() {
  DrawMain();

  const canvas = document.getElementById('main');
  const g = canvas.getContext('2d');
  g.drawImage(gScreen, 0, 0, gScreen.width, gScreen.height, 0, 0, gWidth, gHeight);

}
//ブラウザサイズ変更イベント
function WmSize() {
  const canvas = document.getElementById('main');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  const g = canvas.getContext('2d');
  g.imageSmoothingEnabled = g.msImageSmoothingEnabled = 0;

  gWidth = canvas.width;
  gHeight = canvas.height;
  if (gWidth / WIDTH < gHeight / HEIGHT) {
    gHeight = gWidth * HEIGHT / WIDTH;
  } else {
    gWidth = gHeight * WIDTH / HEIGHT;
  }
}

//タイマーイベント
function WmTimer() {
  if (!gMessage1) {
    gFrame++;
    TickField();//フィールド進行処理
  }
  WmPaint();
}

//キー入力(DOWN)イベント
window.onkeydown = function (ev) {
  let c = ev.keyCode; //キーコード取得

  if (gKey[c] != 0) {
    return;
  }
  gKey[c] = 1;

  if (gPhase == 1) {  //敵が現れた場合
    CommandFight();//コマンド選択
    return;
  }
  if (gPhase == 2) {
    if (c == 13 || c == 90) {//Enterキー又はZキーの場合
      gOrder = Math.random() * 2;//行動順
      Action();//戦闘行動処理
    } else {
      gCursor = 1 - gCursor;//カーソル移動
    }
    return;
  }

  if (gPhase == 3) {
    Action();//戦闘行動処理
    return;
  }

  if (gPhase == 4) {
    CommandFight();//コマンド選択
    return;
  }

  if (gPhase == 5) {
    gPhase = 6;
    AddExp(gEnemyType + 1);//経験値加算
    SetMessage(gMonsterName[gEnemyType] + 'をたおした', null);
    return;
  }

  if (gPhase == 6) {
    if (IsBoss() && gCursor == 0) {
      SetMessage('竜王をたおし', '世界に平和がおとずれた');
      return;
    }
    gPhase = 0    //マップ移動フェーズ

  }

  if (gPhase == 7) {
    gPhase = 8
    SetMessage('あなたは力尽きた', null)
    return;
  }

  if (gPhase == 8) {
    SetMessage('死んでしまうとは', 'なさけない')
    gPlayerX = 464;
    gPlayerY = 336;
    gPhase = 0
    gHP = gMHP;//HP回復
    return;
  }

  gMessage1 = null;

}

//キー入力(UP)イベント
window.onkeyup = function (ev) {
  gKey[ev.keyCode] = 0
}

//起動イベント
window.onload = function () {
  LoadImage();

  gScreen = document.createElement('canvas');
  gScreen.width = WIDTH;
  gScreen.height = HEIGHT;
  WmSize();
  window.addEventListener('resize', function () { WmSize });
  setInterval(function () { WmTimer() }, INTERVAL); //fps

}